@model Sitemaker.Models.Site
@using System.Web.Script.Serialization;
@{
    ViewBag.Title = "Comments";
}

@Styles.Render("~/Content/Comment.css")
@Styles.Render("~/Content/Rating")


<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<style type='text/css'>
    #signature {
        padding-top: 20%;
    }
</style>

<script type="text/javascript">
    $(function () {
        $(document).ready(function () {
            let averageRating = +($(".AverageRating").text());
            $(".star").each(function (i, element) {
                if (i / 2 <= +(averageRating)) $(element).addClass("selected")
                else return false;
            });
            if (+(averageRating) == 5) $(".star").addClass("max");
            if (+(averageRating) == 1) $(".star-1").addClass("min");
        });
        let id = window.location.href;
        let position = id.lastIndexOf("/");
        id = id.slice(position + 1);
        $(".stars label").click(function () { 
            $(".star").removeClass("selected");
            $(".star").removeClass("max");
            $(".star").removeClass("min");
            let model = {
                Id: id, 
                rating: null
            }
            let elem = $(this).attr("class");
            $(".star").each(function (i, element) {
                if (element.className == elem) {
                    model.rating = element.id;
                    return false;
                }
                $(element).addClass("selected")               
            });
            if (elem == "star star-1") { $(this).addClass("min") }
            $(this).addClass("selected");
            if (elem == "star star-5") { $(".star").addClass("max") }

            $.ajax({
                type: 'POST',
                url: "/Sites/AddRating",
                dataType: 'text',
                data: model,
                success: function (data) {
                    window.location.replace(window.location.href);
                }
            });
            
        });
    });
</script>

<style>
    .tags {
  list-style: none;
  margin: 0;
  overflow: hidden; 
  padding: 0;
}

.tags li {
  float: left; 
}

.tag {
  background: #eee;
  border-radius: 3px 0 0 3px;
  color: #999;
  display: inline-block;
  height: 26px;
  line-height: 26px;
  padding: 0 20px 0 23px;
  position: relative;
  margin: 0 10px 10px 0;
  text-decoration: none;
  -webkit-transition: color 0.2s;
}

.tag::before {
  background: #fff;
  border-radius: 10px;
  box-shadow: inset 0 1px rgba(0, 0, 0, 0.25);
  content: '';
  height: 6px;
  left: 10px;
  position: absolute;
  width: 6px;
  top: 10px;
}

.tag::after {
  background: #fff;
  border-bottom: 13px solid transparent;
  border-left: 10px solid #eee;
  border-top: 13px solid transparent;
  content: '';
  position: absolute;
  right: 0;
  top: 0;
}

.tag:hover {
  background-color: crimson;
  color: white;
}

.tag:hover::after {
   border-left-color: crimson; 
}
</style>
@{
    JavaScriptSerializer jss = new JavaScriptSerializer();
    string output = jss.Serialize(Model.Tags.Select(x => x.Name));
    string source = jss.Serialize(ViewBag.Tags);
}

<div class="jumbotron">
<table class="table">
    <tr></tr>

        <tr>
            <td>
                <h2>@Model.Name</h2>
                <p>
                    <img style="width:120px; height:120px" src="@Model.Logo" />
                </p>
                <p>
                    <div class="stars">
                        <form action="" class="formstars">
                            <input class="star star-1" id="1" type="radio" name="star" />
                            <label class="star star-1" for="1"></label>
                            <input class="star star-2" id="2" type="radio" name="star" />
                            <label class="star star-2" for="2"></label>
                            <input class="star star-3" id="3" type="radio" name="star" />
                            <label class="star star-3" for="3"></label>
                            <input class="star star-4" id="4" type="radio" name="star" />
                            <label class="star star-4" for="4"></label>
                            <input class="star star-5" id="5" type="radio" name="star" />
                            <label class="star star-5" for="5"></label>
                        </form>
                    </div>
                </p>
                <p>
                    <ul class="tags">
                        @foreach (var item in Model.Tags)
                        {
                            <li><a href="@Url.Action("Search", "Sites", new {SearchValue = @item.Name, tagSearch=true})" class="tag">@item.Name</a></li>
                        }
                    </ul>
                </p>
                    <ul itemscope itemtype="http://data-vocabulary.org/Review-aggregate">
                        <li >Rating:<strong class="AverageRating" itemprop="average">@Model.AverageRating</strong></li>
                        <li>based on: <strong itemprop="count">@Model.RatingCount</strong> reviews</li>
                    </ul>
            </td>
            <td>
                @Model.About
            </td>
            <td id="signature"><a href="@Url.Action("ShowUser", "Sites", new {userName = (string)Session["CurrentUserName"], siteCreator = Model.UserName })">@Model.UserName</a>, @Model.Date</td>
</table>
</div>

@if (User.Identity.IsAuthenticated)
{
    <body>
    <div class="container">
        <form role="form">
            <div class="form-group">
                <label for="comment">Comment:</label>
                <textarea class="form-control" rows="5" id="comment"></textarea>
                <input type="button" id="addComment" class="btn btn-primary" value="Add">
            </div>
        </form>
    </div>
    </body>
}


<section class="messages">
@foreach (var item in Model.Comments.Reverse())
{
    <article class="message">
        <a class="message-img" href="#non">
            <img src="~/img/userIcon.png"  width="50" height="50">
        </a>
        <div class="message-body">
            <div class="text">
                <p>@item.UserComment</p>
            </div>
            <p class="attribution"><a href="@Url.Action("ShowUser", "Sites", new {userName = (string)Session["CurrentUserName"], siteCreator = item.UserName })">@item.UserName</a>, @item.Date</p>
        </div>
    </article>
}  
</section>​

@Scripts.Render("~/bundles/addComment")

